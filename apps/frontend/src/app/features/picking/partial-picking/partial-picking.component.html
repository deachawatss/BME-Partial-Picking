<!-- Main Container with Brown Theme Background -->
<div class="partial-picking-container">

  <!-- Header Section with Run and FG Item Info -->
  <div class="header-section" [formGroup]="partialPickingForm">
    <!-- Row 1: Run No + FG Item Key -->
    <div class="header-row">
      <div class="header-field">
        <label class="header-label">Run No</label>
        <div class="header-input-group">
          <input type="text" class="header-input" formControlName="runNo" />
          <button class="lookup-button" (click)="onLookup('runNo')">üîç</button>
        </div>
      </div>
      <div class="header-field">
        <label class="header-label">FG Item Key</label>
        <span class="header-display">{{ partialPickingData().fgItemKey }}</span>
        <span class="header-description">{{ partialPickingData().fgDescription }}</span>
      </div>
    </div>

    <!-- Row 2: Batch No + Batch Info -->
    <div class="header-row">
      <div class="header-field">
        <label class="header-label">Batch No</label>
        <div class="header-input-group">
          <input type="text" class="header-input" formControlName="batchNo" />
          <button class="lookup-button" (click)="onLookup('batchNo')">üîç</button>
        </div>
      </div>
      <div class="header-field batch-info">
        <label class="header-label">Batches</label>
        <span class="header-display">{{ partialPickingData().batches }}</span>
        <span class="header-separator">@</span>
        <span class="header-display">1.0000</span>
        <label class="header-label">Production Date</label>
        <span class="header-display">{{ partialPickingData().productionDate }}</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area - Left Form Fields + Right Table -->
  <div class="main-content" [formGroup]="partialPickingForm">

    <!-- Left Column: Form Fields -->
    <div class="form-section">

      <!-- Item Key -->
      <div class="form-field">
        <label class="field-label">Item Key</label>
        <div class="field-input-group">
          <input type="text" class="field-input" formControlName="itemKey" />
          <button class="lookup-button" (click)="onLookup('itemKey')">üîç</button>
          <input type="text" class="field-input readonly-field uom-field"
                 formControlName="unitOfMeasure" readonly
                 [value]="partialPickingData().unitOfMeasure" />
        </div>
      </div>

      <!-- Description -->
      <div class="form-field">
        <label class="field-label">Description</label>
        <input type="text" class="field-input description-input" formControlName="description" />
      </div>

      <!-- Lot No -->
      <div class="form-field">
        <label class="field-label">Lot No.</label>
        <div class="field-input-group">
          <input type="text" class="field-input" formControlName="lotNo" />
          <button class="lookup-button" (click)="onLookup('lotNo')">üîç</button>
          <span class="soh-label">SOH</span>
        </div>
      </div>

      <!-- Bin No -->
      <div class="form-field">
        <label class="field-label">Bin No.</label>
        <div class="field-input-group">
          <input type="text" class="field-input" formControlName="binNo" />
          <button class="lookup-button" (click)="onLookup('binNo')">üîç</button>
          <span class="bin-display">{{ partialPickingData().binSOHDisplay }}</span>
        </div>
      </div>

      <!-- Weight - Critical Field with Emphasis -->
      <div class="form-field weight-field">
        <label class="field-label">Weight</label>
        <div class="weight-input-group">
          <input type="number" class="field-input weight-input"
                 formControlName="weight"
                 [class.weight-in-range]="isWeightInRange()"
                 [class.weight-out-of-range]="!isWeightInRange() && partialPickingData().weight > 0"
                 [value]="formatNumber(partialPickingData().weight)" />
          <button class="fetch-weight-button"
                  (click)="onFetchWeight()"
                  [disabled]="isLoading()">
            @if (isLoading()) {
              <span class="loading-spinner"></span>
            } @else {
              Fetch Weight
            }
          </button>
        </div>

        <!-- Progressive Weight Bar -->
        <div class="weight-progress-container">
          <div class="weight-progress-bar">
            <div class="weight-progress-fill"
                 [class.in-tolerance]="isWeightInRange()"
                 [class.out-of-tolerance]="!isWeightInRange() && partialPickingData().weight > 0"
                 [style.width.%]="partialPickingData().weight > 0 ? 75 : 0"></div>
            <div class="weight-progress-indicator"
                 [style.left.%]="partialPickingData().weight > 0 ? 70 : 0"></div>
          </div>
          <div class="weight-progress-labels">
            <span>{{ formatNumber(partialPickingData().weightRangeMin) }} kg</span>
            <span>Target Range</span>
            <span>{{ formatNumber(partialPickingData().weightRangeMax) }} kg</span>
          </div>
          <div class="weight-status-text"
               [class.in-tolerance]="isWeightInRange()"
               [class.out-of-tolerance]="!isWeightInRange() && partialPickingData().weight > 0"
               [class.neutral]="partialPickingData().weight === 0">
            @if (partialPickingData().weight === 0) {
              Ready for weighing
            } @else if (isWeightInRange()) {
              Weight within tolerance
            } @else {
              Weight outside tolerance
            }
          </div>
        </div>
      </div>

      <!-- Weight Range -->
      <div class="form-field">
        <label class="field-label">Weight Range</label>
        <div class="weight-range-group">
          <input type="number" class="field-input range-input"
                 formControlName="weightRangeMin"
                 [value]="formatNumber(partialPickingData().weightRangeMin)" readonly />
          <span class="range-separator">-</span>
          <input type="number" class="field-input range-input"
                 formControlName="weightRangeMax"
                 [value]="formatNumber(partialPickingData().weightRangeMax)" readonly />
        </div>
      </div>

      <!-- Total Needed -->
      <div class="form-field">
        <label class="field-label">Total Needed</label>
        <input type="number" class="field-input number-input"
               formControlName="totalNeeded"
               [value]="formatNumber(partialPickingData().totalNeeded)" readonly />
      </div>

      <!-- Remaining Qty -->
      <div class="form-field">
        <label class="field-label">Remaining Qty</label>
        <input type="number" class="field-input number-input"
               formControlName="remainingQty"
               [value]="formatNumber(partialPickingData().remainingQty)" readonly />
      </div>

    </div>

    <!-- Right Column: Batch Ticket Partials Table -->
    <div class="table-section">
      <div class="table-container">
        <div class="table-header">Batch Ticket Partials</div>
        <div class="table-status-tabs">
          <span class="status-tab active">Pending to Picked</span>
          <span class="status-tab">Picked</span>
        </div>
        <div class="data-table">
          <div class="table-header-row">
            <div class="table-cell header-cell">Item</div>
            <div class="table-cell header-cell">BatchNo</div>
            <div class="table-cell header-cell">Partial</div>
            <div class="table-cell header-cell">Weighted</div>
            <div class="table-cell header-cell">Balance</div>
            <div class="table-cell header-cell">Allergens</div>
          </div>
          @for (item of batchTicketPartials(); track item.batchNo; let i = $index) {
            <div class="table-data-row" (click)="onSelectBatchRow(i)"
                 [class.selected-row]="item.item === 'INFULM01'">
              <div class="table-cell data-cell">{{ item.item }}</div>
              <div class="table-cell data-cell">{{ item.batchNo }}</div>
              <div class="table-cell data-cell number-cell">{{ formatNumber(item.partial) }}</div>
              <div class="table-cell data-cell number-cell">{{ formatNumber(item.weighted) }}</div>
              <div class="table-cell data-cell number-cell">{{ formatNumber(item.balance) }}</div>
              <div class="table-cell data-cell">{{ item.allergens ?? 'None' }}</div>
            </div>
          }
        </div>
      </div>
    </div>

  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="action-button" (click)="onAddLot()">Add Lot</button>
    <button class="action-button" (click)="onViewLots()">View Lots</button>
    <button class="action-button" (click)="onPrint()">Print</button>
    <button class="action-button primary-action" (click)="onSave()" [disabled]="isLoading()">
      @if (isLoading()) {
        <span class="loading-spinner"></span>
        Saving...
      } @else {
        Save
      }
    </button>
    <button class="action-button danger-action" (click)="onExit()">Exit</button>
  </div>

  <!-- Error Message Display -->
  @if (hasError()) {
    <div class="error-message">
      <span class="error-icon">‚ö†Ô∏è</span>
      {{ errorMessage() }}
    </div>
  }

</div>