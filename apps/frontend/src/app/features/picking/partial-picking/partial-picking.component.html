<div class="partial-picking-screen">
  <div class="partial-picking-shell" [formGroup]="partialPickingForm">

    <!-- Large Progress Bar -->
    <app-weight-progress-bar
      [currentWeight]="currentWeight()"
      [config]="progressConfig()"
      [isConnected]="isScaleConnected()"
      [isStable]="isWeightStable()"
      (tareScale)="onTareScale()"
      (reconnectScale)="onReconnectScale()">
    </app-weight-progress-bar>

    <!-- Header Row 1: Run No and FG Item Key -->
    <div class="header-row">
      <div class="header-field">
        <label class="field-label">Run No</label>
        <div class="input-wrap">
          <input type="text" formControlName="runNo" />
          <button type="button" class="lookup-btn" (click)="onLookup('runNo')" aria-label="Lookup run number">üîç</button>
        </div>
      </div>
      <div class="header-field fg-field">
        <label class="field-label">FG Item Key</label>
        <div class="fg-cell">
          <div class="fg-token fg-key">{{ partialPickingData().fgItemKey }}</div>
          <div class="fg-token fg-desc">{{ partialPickingData().fgDescription }}</div>
        </div>
      </div>
    </div>

    <!-- Header Row 2: Batch No, Batches Info, Tabs -->
    <div class="header-row header-row-with-tabs">
      <div class="header-field">
        <label class="field-label">Batch No</label>
        <div class="input-wrap">
          <input type="text" formControlName="batchNo" />
          <button type="button" class="lookup-btn" (click)="onLookup('batchNo')" aria-label="Lookup batch number">üîç</button>
        </div>
      </div>
      <div class="header-field batch-field">
        <label class="field-label">Batches</label>
        <div class="meta-inline">
          <span class="meta-box">{{ partialPickingData().batches }}</span>
          <span class="meta-separator">@</span>
          <span class="meta-box">1.0000</span>
          <span class="meta-label">Production Date</span>
          <span class="meta-box">{{ partialPickingData().productionDate }}</span>
        </div>
      </div>
      <div class="header-tabs">
        <div class="tab-strip">
          <button type="button" class="tab-btn active">Pending to Picked</button>
          <button type="button" class="tab-btn">Picked</button>
        </div>
      </div>
    </div>

    <!-- Main Content: Form Left, Table Right -->
    <div class="main-content">
      <div class="form-column">
        <table class="form-table">
          <tbody>
            <tr>
              <th scope="row">Item Key</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="text" formControlName="itemKey" />
                  <button type="button" class="lookup-btn" (click)="onLookup('itemKey')" aria-label="Lookup item key">üîç</button>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Description</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="text" formControlName="description" />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Lot No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="lotNo" />
                  <button type="button" class="lookup-btn" (click)="onLookup('lotNo')" aria-label="Lookup lot number">üîç</button>
                </div>
              </td>
              <td class="soh-field">
                <span class="soh-text">SOH</span>
              </td>
            </tr>
            <tr>
              <th scope="row">Bin No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="binNo" />
                  <button type="button" class="lookup-btn" (click)="onLookup('binNo')" aria-label="Lookup bin number">üîç</button>
                </div>
              </td>
              <td class="soh-display">
                <div class="soh-value-wrap">
                  <div class="soh-token">{{ binSohValue() }}</div>
                  <div class="soh-token soh-token-unit">{{ binSohUnit() }}</div>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight</th>
              <td>
                <div class="input-wrap" [class.weight-in-range]="isFormWeightInRange()" [class.weight-out-of-range]="!isFormWeightInRange() && partialPickingData().weight > 0">
                  <input type="number" formControlName="weight" inputmode="decimal" [value]="getCurrentWeightDisplay()" readonly />
                </div>
              </td>
              <td class="fetch-controls">
                <button type="button" class="fetch-btn" (click)="onFetchWeight()" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <span class="spinner"></span>
                    <span>Fetching</span>
                  } @else {
                    Fetch Weight
                  }
                </button>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight Range</th>
              <td colspan="2">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMin)" readonly />
                  </div>
                  <span>to</span>
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMax)" readonly />
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Total Needed</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="number" [value]="formatNumber(partialPickingData().totalNeeded)" readonly />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Remaining Qty</th>
              <td colspan="2">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().remainingQty)" readonly />
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="form-actions">
          <div class="form-action-row">
            <button type="button" class="action-btn secondary" (click)="onAddLot()">Add Lot</button>
            <button type="button" class="action-btn secondary" (click)="onViewLots()">View Lots</button>
          </div>
          <div class="form-action-row form-action-row-primary">
            <button type="button" class="action-btn secondary" (click)="onPrint()">Print</button>
            <button type="button" class="action-btn" (click)="onSave()">Save</button>
          </div>
          <div class="form-action-row form-action-row-full">
            <button type="button" class="action-btn danger" (click)="onExit()">Exit</button>
          </div>
        </div>
      </div>

      <div class="table-column">
        <div class="table-panel">
          <section class="table-panel-body">
            <div class="table-scroll">
              <table class="batch-table">
                <colgroup>
                  <col />
                  <col />
                  <col />
                  <col />
                  <col />
                  <col />
                </colgroup>
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Batch No</th>
                    <th>Partial</th>
                    <th>Weighted</th>
                    <th>Balance</th>
                    <th>Allergens</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of batchTicketPartials(); track item.batchNo; let i = $index) {
                    <tr
                      (click)="onSelectBatchRow(i)"
                      (keydown.enter)="onSelectBatchRow(i)"
                      (keydown.space)="onSelectBatchRow(i); $event.preventDefault()"
                      [class.selected]="isBatchRowSelected(i)"
                      [attr.aria-selected]="isBatchRowSelected(i)"
                      tabindex="0"
                    >
                      <td>{{ item.item }}</td>
                      <td>{{ item.batchNo }}</td>
                      <td class="numeric">{{ formatNumber(item.partial) }}</td>
                      <td class="numeric">{{ formatNumber(item.weighted) }}</td>
                      <td class="numeric">{{ formatNumber(item.balance) }}</td>
                      <td>{{ item.allergens ?? 'None' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </div>

    </div>

  </div>
</div>
