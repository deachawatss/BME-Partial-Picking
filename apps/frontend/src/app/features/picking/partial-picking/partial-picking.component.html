<div class="partial-picking-screen">
  <div class="partial-picking-shell" [formGroup]="partialPickingForm">

    <!-- Large Progress Bar -->
    <app-weight-progress-bar
      [currentWeight]="currentWeight()"
      [config]="progressConfig()"
      [isConnected]="isScaleConnected()"
      [isStable]="isWeightStable()"
      (tareScale)="onTareScale()"
      (reconnectScale)="onReconnectScale()">
    </app-weight-progress-bar>

    <section class="section-frame">
      <table class="header-table">
        <colgroup>
          <col class="col-label" />
          <col class="col-field" />
          <col class="col-label" />
          <col />
        </colgroup>
        <tbody>
          <tr>
            <th scope="row">Run No</th>
            <td>
              <div class="input-wrap">
                <input type="text" formControlName="runNo" />
                <button type="button" class="lookup-btn" (click)="onLookup('runNo')" aria-label="Lookup run number">üîç</button>
              </div>
            </td>
            <th scope="row">FG Item Key</th>
            <td class="fg-cell">
              <div class="fg-key">{{ partialPickingData().fgItemKey }}</div>
              <div class="fg-desc">{{ partialPickingData().fgDescription }}</div>
            </td>
          </tr>
          <tr>
            <th scope="row">Batch No</th>
            <td>
              <div class="input-wrap">
                <input type="text" formControlName="batchNo" />
                <button type="button" class="lookup-btn" (click)="onLookup('batchNo')" aria-label="Lookup batch number">üîç</button>
              </div>
            </td>
            <th scope="row">Batches</th>
            <td>
              <div class="meta-inline">
                <span class="meta-box">{{ partialPickingData().batches }}</span>
                <span class="meta-separator">@</span>
                <span class="meta-box">1.0000</span>
                <span class="meta-label">Production Date</span>
                <span class="meta-box">{{ partialPickingData().productionDate }}</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <div class="body-section">
      <section class="form-panel">
        <table class="form-table">
          <colgroup>
            <col class="col-label" />
            <col class="col-field" />
            <col class="col-util" />
            <col class="col-field" />
          </colgroup>
          <tbody>
            <tr>
              <th scope="row">Item Key</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="text" formControlName="itemKey" />
                </div>
              </td>
              <td>
                <button type="button" class="lookup-btn" (click)="onLookup('itemKey')" aria-label="Lookup item key">üîç</button>
              </td>
            </tr>
            <tr>
              <th scope="row">Description</th>
              <td colspan="3">
                <div class="input-wrap">
                  <input type="text" formControlName="description" />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Lot No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="lotNo" />
                </div>
              </td>
              <td>
                <button type="button" class="lookup-btn" (click)="onLookup('lotNo')" aria-label="Lookup lot number">üîç</button>
              </td>
              <td>
                <div class="input-wrap inline-tag">
                  <input type="text" value="SOH" readonly />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Bin No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="binNo" />
                </div>
              </td>
              <td>
                <button type="button" class="lookup-btn" (click)="onLookup('binNo')" aria-label="Lookup bin number">üîç</button>
              </td>
              <td>
                <div class="input-wrap inline-tag">
                  <input type="text" [value]="partialPickingData().binSOHDisplay" readonly />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Bag Weight</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="number" [value]="formatNumber(partialPickingData().bagWeight)" readonly />
                </div>
              </td>
              <td>
                <div class="meta-inline">
                  <button type="button" class="square-btn" (click)="onCalculateBagWeight()" aria-label="Calculate bag weight">üßÆ</button>
                  <button type="button" class="square-btn" (click)="onLookup('bagWeight')" aria-label="Bag weight presets">üóÇ</button>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight</th>
              <td colspan="2">
                <div class="input-wrap" [class.weight-in-range]="isFormWeightInRange()" [class.weight-out-of-range]="!isFormWeightInRange() && partialPickingData().weight > 0">
                  <input type="number" formControlName="weight" inputmode="decimal" [value]="getCurrentWeightDisplay()" readonly />
                </div>
              </td>
              <td>
                <button type="button" class="fetch-btn" (click)="onFetchWeight()" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <span class="spinner"></span>
                    <span>Fetching</span>
                  } @else {
                    Fetch Weight
                  }
                </button>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight Range</th>
              <td colspan="3">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMin)" readonly />
                  </div>
                  <span>to</span>
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMax)" readonly />
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Total Needed</th>
              <td colspan="3">
                <div class="input-wrap">
                  <input type="number" [value]="formatNumber(partialPickingData().totalNeeded)" readonly />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Remaining Qty</th>
              <td colspan="3">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().remainingQty)" readonly />
                  </div>
                  <span class="help-note">*Intermediate</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="table-panel">
        <div class="table-panel-header">
          <div class="table-title">Batch Ticket Partials</div>
          <div class="tab-strip">
            <button type="button" class="tab-btn active">Pending to Picked</button>
            <button type="button" class="tab-btn">Picked</button>
          </div>
        </div>
        <div class="table-scroll">
          <table class="batch-table">
            <colgroup>
              <col />
              <col />
              <col />
              <col />
              <col />
              <col />
            </colgroup>
            <thead>
              <tr>
                <th>Item</th>
                <th>Batch No</th>
                <th>Partial</th>
                <th>Weighted</th>
                <th>Balance</th>
                <th>Allergens</th>
              </tr>
            </thead>
            <tbody>
              @for (item of batchTicketPartials(); track item.batchNo; let i = $index) {
                <tr (click)="onSelectBatchRow(i)" [class.selected]="item.item === 'INFULM01'">
                  <td>{{ item.item }}</td>
                  <td>{{ item.batchNo }}</td>
                  <td class="numeric">{{ formatNumber(item.partial) }}</td>
                  <td class="numeric">{{ formatNumber(item.weighted) }}</td>
                  <td class="numeric">{{ formatNumber(item.balance) }}</td>
                  <td>{{ item.allergens ?? 'None' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <footer class="footer-actions">
      <div class="operator-info">
        Operator
        <span class="operator-name">{{ getCurrentUser() }}</span>
      </div>
      <div class="action-buttons">
        <button type="button" class="action-btn secondary" (click)="onAddLot()">Add Lot</button>
        <button type="button" class="action-btn secondary" (click)="onViewLots()">View Lots</button>
        <button type="button" class="action-btn secondary" (click)="onPrint()">Print</button>
        <button type="button" class="action-btn" (click)="onSave()">Save</button>
        <button type="button" class="action-btn danger" (click)="onExit()">Exit</button>
      </div>
    </footer>

  </div>
</div>
